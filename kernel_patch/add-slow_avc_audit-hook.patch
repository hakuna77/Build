From 34d921158c4b5f344438b9485be78b7062a679ad Mon Sep 17 00:00:00 2001
From: backslashxx <118538522+backslashxx@users.noreply.github.com>
Date: Sun, 19 Oct 2025 21:52:12 +0800
Subject: [PATCH] KernelSU, selinux/avc: add slow_avc_audit hook

since kprobes is broken on this kernel, manual hook is needed for avc log spoofing

Signed-off-by: backslashxx <118538522+backslashxx@users.noreply.github.com>
---
 security/selinux/avc.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/security/selinux/avc.c b/security/selinux/avc.c
index 1b8f957c2b5f..cdd8880ae578 100644
--- a/security/selinux/avc.c
+++ b/security/selinux/avc.c
@@ -761,6 +761,10 @@ static void avc_audit_post_callback(struct audit_buffer *ab, void *a)
 	}
 }
 
+#ifdef CONFIG_KSU
+extern int ksu_handle_slow_avc_audit(u32 *tsid);
+#endif
+
 /* This is the slow part of avc audit with big stack footprint */
 noinline int slow_avc_audit(struct selinux_state *state,
 			    u32 ssid, u32 tsid, u16 tclass,
@@ -771,6 +775,9 @@ noinline int slow_avc_audit(struct selinux_state *state,
 	struct common_audit_data stack_data;
 	struct selinux_audit_data sad;
 
+#ifdef CONFIG_KSU
+	ksu_handle_slow_avc_audit(&tsid);
+#endif
 	if (!a) {
 		a = &stack_data;
 		a->type = LSM_AUDIT_DATA_NONE;
