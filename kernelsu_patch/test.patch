From 95c92e625669a02005c3944cb4758bc484a79774 Mon Sep 17 00:00:00 2001
From: hakuna77 <194330619+hakuna77@users.noreply.github.com>
Date: Tue, 9 Dec 2025 01:34:41 +0000
Subject: [PATCH] test

---
 kernel/selinux/sepolicy.c |  2 +-
 kernel/setuid_hook.c      | 32 ++++++++++++++++++++++++--------
 2 files changed, 25 insertions(+), 9 deletions(-)

diff --git a/kernel/selinux/sepolicy.c b/kernel/selinux/sepolicy.c
index d58fdffd..262d8b4d 100644
--- a/kernel/selinux/sepolicy.c
+++ b/kernel/selinux/sepolicy.c
@@ -356,7 +356,7 @@ static void add_xperm_rule_raw(struct policydb *db, struct type_datum *src,
 		if (datum->u.xperms == NULL) {
 			datum->u.xperms =
 				(struct avtab_extended_perms *)(kzalloc(
-					sizeof(xperms), GFP_KERNEL));
+					sizeof(xperms), GFP_ATOMIC));
 			if (!datum->u.xperms) {
 				pr_err("alloc xperms failed\n");
 				return;
diff --git a/kernel/setuid_hook.c b/kernel/setuid_hook.c
index 879a1431..934880c5 100644
--- a/kernel/setuid_hook.c
+++ b/kernel/setuid_hook.c
@@ -92,6 +92,25 @@ static inline bool is_allow_su(void)
 	return ksu_is_allow_uid_for_current(current_uid().val);
 }
 
+static void ksu_install_manager_fd_tw_func(struct callback_head *cb)
+{
+	ksu_install_fd();
+	kfree(cb);
+}
+
+static void do_install_manager_fd(void)
+{
+	struct callback_head *cb = kzalloc(sizeof(*cb), GFP_ATOMIC);
+	if (!cb)
+		return;
+
+	cb->func = ksu_install_manager_fd_tw_func;
+	if (task_work_add(current, cb, TWA_RESUME)) {
+		kfree(cb);
+		pr_warn("install manager fd add task_work failed\n");
+	}
+}
+
 // force_sig kcompat, TODO: move it out of core_hook.c
 // https://elixir.bootlin.com/linux/v5.3-rc1/source/kernel/signal.c#L1613
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 3, 0)
@@ -143,8 +162,6 @@ int ksu_handle_setuid_common(uid_t new_uid, uid_t old_uid, uid_t new_euid,
 #endif // #ifdef CONFIG_KSU_SUSFS_SUS_MOUNT
 
 	if (ksu_get_manager_appid() == new_uid % PER_USER_RANGE) {
-		pr_info("install fd for ksu manager(uid=%d)\n", new_uid);
-		ksu_install_fd();
 		spin_lock_irq(&current->sighand->siglock);
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 10, 0)
 		ksu_seccomp_allow_cache(current->seccomp.filter, __NR_reboot);
@@ -152,6 +169,8 @@ int ksu_handle_setuid_common(uid_t new_uid, uid_t old_uid, uid_t new_euid,
 		disable_seccomp(current);
 #endif
 		spin_unlock_irq(&current->sighand->siglock);
+		pr_info("install fd for manager (uid=%d)\n", new_uid);
+		do_install_manager_fd();
 		return 0;
 	}
 
@@ -173,12 +192,9 @@ int ksu_handle_setuid_common(uid_t new_uid, uid_t old_uid, uid_t new_euid,
 	}
 #else
 	if (ksu_is_allow_uid_for_current(new_uid)) {
-		// FIXME: Should do proper checking
-		if (current->seccomp.filter != NULL) {
-			spin_lock_irq(&current->sighand->siglock);
-			disable_seccomp(current);
-			spin_unlock_irq(&current->sighand->siglock);
-		}
+		spin_lock_irq(&current->sighand->siglock);
+		disable_seccomp(current);
+		spin_unlock_irq(&current->sighand->siglock);
 	}
 #endif
 
-- 
2.34.1

