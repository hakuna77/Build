From c1efc06f519af2be5960d9180ced5085f976083e Mon Sep 17 00:00:00 2001
From: hakuna77 <akuntrial045@gmail.com>
Date: Sat, 8 Nov 2025 15:25:43 +0000
Subject: [PATCH] fix sukisu for non-gki

---
 kernel/allowlist.c       | 5 ++++-
 kernel/selinux/selinux.c | 8 ++++++++
 kernel/supercalls.c      | 8 +++++++-
 3 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/kernel/allowlist.c b/kernel/allowlist.c
index 947048f2..439f6dbf 100644
--- a/kernel/allowlist.c
+++ b/kernel/allowlist.c
@@ -419,8 +419,11 @@ void persistent_allow_list()
         goto put_task;
     }
     cb->func = do_persistent_allow_list;
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 1, 0)
     task_work_add(tsk, cb, TWA_RESUME);
-
+#else
+    task_work_add(tsk, cb, true);
+#endif
 put_task:
     put_task_struct(tsk);
 }
diff --git a/kernel/selinux/selinux.c b/kernel/selinux/selinux.c
index 57c2be1b..4e2cdab5 100644
--- a/kernel/selinux/selinux.c
+++ b/kernel/selinux/selinux.c
@@ -116,7 +116,11 @@ bool is_task_ksu_domain(const struct cred* cred)
     if (!cred) {
         return false;
     }
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 1, 0)
     const struct task_security_struct *tsec = selinux_cred(cred);
+#else
+    const struct task_security_struct *tsec = cred->security;
+#endif
     if (!tsec) {
         return false;
     }
@@ -140,7 +144,11 @@ bool is_zygote(const struct cred* cred)
     if (!cred) {
         return false;
     }
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 1, 0)
     const struct task_security_struct * tsec = selinux_cred(cred);
+#else
+    const struct task_security_struct * tsec = cred->security;
+#endif
     if (!tsec) {
         return false;
     }
diff --git a/kernel/supercalls.c b/kernel/supercalls.c
index 897c7634..5fef0335 100644
--- a/kernel/supercalls.c
+++ b/kernel/supercalls.c
@@ -393,7 +393,13 @@ static int do_get_wrapper_fd(void __user *arg) {
     struct file* pf = fget(ret);
 
     struct inode* wrapper_inode = file_inode(pf);
-    struct inode_security_struct *sec = selinux_inode(wrapper_inode);
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 1, 0) ||                           \
+	defined(KSU_OPTIONAL_SELINUX_INODE)
+	struct inode_security_struct *sec = selinux_inode(wrapper_inode);
+#else
+	struct inode_security_struct *sec =
+		(struct inode_security_struct *)wrapper_inode->i_security;
+#endif
     if (sec) {
         sec->sid = ksu_file_sid;
     }
-- 
2.34.1

